# 開発状況レポート (2025-02-17)

## プロジェクト概要
- プロジェクト名: AI Blog Generator
- 目的: OpenAI APIを活用したブログ記事生成アプリケーション
- 開発環境: Node.js, React, TypeScript, Supabase

## 現在の実装状況

### 1. フロントエンド機能
- ✅ ユーザー認証（Supabase Auth）
- ✅ ブログ記事生成フォーム
- ✅ AIによるタイトル生成
- ✅ AIによる記事構成生成
- ✅ ダークモード対応
- ✅ レスポンシブデザイン

### 2. バックエンド機能
- ✅ OpenAI API連携
- ✅ Supabaseデータベース連携
- ✅ エラーハンドリング
- ✅ ヘルスチェック機能
- ✅ メモリ使用量モニタリング

### 3. インフラストラクチャ
- ✅ Supabase設定
- ✅ 環境変数管理
- ✅ ログ管理システム

## 既知の問題点

### 1. サーバー起動関連
- サーバー起動コマンドに誤字が含まれやすい
  - 誤: `node scripts/server.js > server.log 2>&1 &s > server`
  - 正: `node scripts/server.js > server.log 2>&1 &`
- メモリ制限の設定が必要
  - `NODE_OPTIONS="--max-old-space-size=512"`を使用

### 2. API関連
- OpenAI APIのレスポンス形式の変更への対応が必要
- エラーメッセージの日本語化が不完全
- APIキーの検証強化が必要

### 3. パフォーマンス
- メモリ使用量が80%を超えることがある
- レスポンスタイムの最適化が必要

## 正しい起動手順

### 1. 開発環境の準備
```bash
# 依存関係のインストール
npm install

# 環境変数の設定確認
# .envファイルに以下が設定されていることを確認
# - VITE_SUPABASE_URL
# - VITE_SUPABASE_ANON_KEY
# - VITE_APP_URL
# - VITE_SUPABASE_FUNCTIONS_URL
# - OPENAI_API_KEY
```

### 2. サーバーの起動
#### 方法1: スクリプトを使用（推奨）
```bash
# すべてのサーバーを一括起動
npm run start-all
```

#### 方法2: 個別起動
```bash
# 1. Supabaseの起動
npm run supabase:start

# 2. バックエンドサーバーの起動
NODE_ENV=development NODE_OPTIONS="--max-old-space-size=512" node scripts/server.js > server.log 2>&1 &

# 3. フロントエンドサーバーの起動
npm run dev
```

### 3. 動作確認
- Supabase: http://127.0.0.1:54321
- バックエンド: http://localhost:3000
- フロントエンド: http://localhost:5173

## トラブルシューティング

### 1. サーバー起動エラー
```bash
# すべてのプロセスを停止
npm run supabase:stop && pkill -f vite && pkill -f "node scripts/server.js"

# ログの確認
tail -n 100 server.log
```

### 2. メモリ使用量の問題
- `NODE_OPTIONS="--max-old-space-size=512"`の設定
- 定期的なサーバー再起動の検討

### 3. API接続エラー
- OpenAI APIキーの形式確認
- CORSの設定確認
- ネットワーク接続の確認

## Git管理

### コミット手順
```bash
# 変更状態の確認
git status

# 変更ファイルの追加
git add .

# 変更内容の確認
git diff --cached

# コミット
git commit -m "feat: AI Blog Generator初期実装

- フロントエンド: ユーザー認証、ブログ生成フォーム実装
- バックエンド: OpenAI API連携、Supabase設定
- インフラ: 環境変数設定、ログ管理システム実装"

# リモートリポジトリへのプッシュ
git push origin main
```

### .gitignoreの設定
```plaintext
# 依存関係
node_modules/
.pnp
.pnp.js

# ビルド出力
dist/
build/

# 環境変数
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# ログファイル
*.log
logs/
server.log

# エディタ設定
.vscode/
.idea/
*.swp
*.swo

# OS生成ファイル
.DS_Store
Thumbs.db
```

### 重要なブランチ
- `main`: 本番環境用の安定版コード
- `develop`: 開発用のメインブランチ
- `feature/*`: 新機能開発用
- `fix/*`: バグ修正用

### コミットメッセージの規約
```plaintext
# コミットメッセージの形式
<type>: <subject>

# 本文（オプション）
<body>

# タイプの種類
- feat: 新機能
- fix: バグ修正
- docs: ドキュメントのみの変更
- style: コードの意味に影響を与えない変更（空白、フォーマット等）
- refactor: バグ修正や機能追加のないコードの変更
- perf: パフォーマンス向上のための変更
- test: テストの追加・修正
- chore: ビルドプロセスやドキュメント生成の変更
```

## 次回の開発に向けて

### 1. 優先度の高い改善点
- [ ] サーバー起動スクリプトの改善
- [ ] エラーハンドリングの強化
- [ ] パフォーマンスモニタリングの実装
- [ ] ログ管理システムの改善
- [ ] Gitワークフローの確立
- [ ] CIパイプラインの構築

### 2. 技術的な検討事項
- Supabase Edge Functionsへの移行検討
- メモリ使用量の最適化
- エラーログの構造化

### 3. ドキュメント整備
- API仕様書の作成
- 環境構築手順の詳細化
- トラブルシューティングガイドの拡充

## 参考情報

### 使用している主要なパッケージ
- Vite v5.4.14
- React v18.3.1
- TypeScript v5.5.3
- Supabase CLI v1.226.4（v2.12.1へのアップデートを推奨）

### 重要なファイル
- `scripts/server.js`: バックエンドサーバー
- `scripts/start-servers.sh`: 起動スクリプト
- `src/lib/openai.ts`: OpenAI API連携
- `.env`: 環境変数設定

### 関連ドキュメント
- [OpenAI API Documentation](https://platform.openai.com/docs/api-reference)
- [Supabase Documentation](https://supabase.com/docs)
- [Vite Documentation](https://vitejs.dev/guide/)

## 改善報告（2024-02-19）

### サーバー安定性の改善

#### 1. ログファイル関連の問題解決
- 問題：ログファイルのパスが正しく設定されておらず、書き込みに失敗してエラーが発生
- 改善内容：
  ```javascript
  const LOG_DIR = path.join(process.cwd(), 'logs');
  ```
  - `path.join`を使用して正しいパスを生成
  - 起動時にログディレクトリを確実に作成する処理を追加：
    ```javascript
    if (!fs.existsSync(LOG_DIR)) {
      fs.mkdirSync(LOG_DIR, { recursive: true });
    }
    ```

#### 2. エラーハンドリングの強化
- 問題：ログ書き込みエラーがサーバーをクラッシュさせていた
- 改善内容：ログ関数にtry-catchを追加
  ```javascript
  const logError = (message, error = null) => {
    try {
      // ログ書き込み処理
    } catch (err) {
      console.error('ログの書き込みに失敗:', err);
    }
  };
  ```

#### 3. 起動スクリプトの改善
- 問題：ログディレクトリの権限が適切に設定されていなかった
- 改善内容：
  ```bash
  mkdir -p logs
  chmod 755 logs
  rm -f logs/*.log  # 古いログファイルを確実にクリーンアップ
  ```

#### 4. メモリ管理の最適化
- 問題：メモリ使用量が80%を超えると即座にシャットダウン
- 改善内容：
  - 警告閾値を70%に下げて早期警告を実施
  - GC（ガベージコレクション）後も閾値を超えた場合のみシャットダウン

### 改善結果
- サーバーの安定性が向上
- ログファイル関連のエラーが適切に処理されるように
- メモリ管理の予防的な対応が可能に

### 残存する課題
- AIによる記事構成生成時のエラー
  - 原因調査が必要
  - エラーログの詳細な分析が必要

## 開発方針の変更（2025-02-17追記）

### 現状の課題
- ローカルSupabase環境での開発における問題
  - 高メモリ使用量（80%以上）によるサーバークラッシュ
  - 開発環境のセットアップの複雑さ
  - 環境間の一貫性の維持が困難

### 新開発方針
1. **環境構成の変更**
   - 現在のアプローチ（廃止予定）:
     ```
     ローカル開発環境 → 本番環境
     └── ローカルSupabase  → Supabase Cloud
     └── ローカルサーバー  → 本番サーバー
     ```
   - 新アプローチ:
     ```
     開発用プロジェクト → ステージング → 本番環境
     └── Supabase Cloud (開発用) → Supabase Cloud (ステージング) → Supabase Cloud (本番)
     └── ローカルサーバー → ステージングサーバー → 本番サーバー
     ```

2. **Supabase環境の分離**
   - 開発用プロジェクト: 無料枠利用
   - ステージング用プロジェクト: 小規模プラン
   - 本番用プロジェクト: 必要スペックのプラン

3. **開発フロー改善**
   - ローカル環境では最小限のサービスのみ実行
   - Supabaseは開発用クラウドプロジェクトを使用
   - 環境変数による接続先の制御
   - マイグレーションツールによるスキーマ管理

### 移行計画
1. **即時対応**
   - 開発用Supabaseプロジェクトの作成
   - 環境変数の更新
   - ローカルSupabase環境の停止

2. **段階的対応**
   - スキーマのマイグレーション
   - 開発環境の接続先変更
   - CI/CDパイプラインの更新

3. **完了条件**
   - すべての開発がクラウドSupabaseを使用
   - ローカル環境のメモリ使用量が適正範囲内
   - 環境間の移行が自動化されている

### 期待される効果
- 開発環境の安定性向上
- セットアップ時間の短縮
- リソース使用量の最適化
- 環境間の一貫性確保
- デプロイプロセスの簡素化

## 最新の開発状況（2025-02-17 追記）

### データ保存の問題

#### 発生している問題
1. **記事生成と保存の不整合**
   - AIによる記事構成生成は成功
   - 生成された記事の保存に失敗
   - セッション関連のエラーが頻発

2. **データ永続化の課題**
   - 更新操作による保存が機能していない
   - バックアップとロールバック機能が期待通りに動作していない

#### 実施した対策
1. **セッション管理の強化**
   - セッションの自動再取得機能の実装
   - リトライメカニズムの導入（最大3回）
   - 指数バックオフによる待機時間の実装

2. **データ整合性の改善**
   - トランザクション的な処理の実装
   - バックアップデータの型定義の追加
   - ロールバック機能の強化

3. **エラーハンドリングの改善**
   - より詳細なエラーチェックの追加
   - null チェックの強化
   - 型安全性の向上

#### 残存する課題
1. **セッション管理**
   - セッションの再取得が完全には機能していない
   - セッション切れによるデータ損失のリスクが継続

2. **データ保存の信頼性**
   - 更新操作時のデータ永続化が不安定
   - バックアップからの復元が確実でない

3. **エラー検出と回復**
   - エラーの根本原因の特定が困難
   - 自動リカバリー機能の信頼性が低い

### 次のステップ

1. **優先度の高い対応**
   - Supabaseセッション管理の完全な見直し
   - データ保存処理のトランザクション管理の再設計
   - エラーログの詳細化とモニタリングの強化

2. **検討すべき方向性**
   - セッション管理方式の変更（より堅牢な方式への移行）
   - データ保存処理の分割（より小さな単位での処理）
   - バックアップ・リストア機能の独立したモジュール化

3. **技術的な検討事項**
   - Supabase RLSポリシーの見直し
   - クライアント側のリトライロジックの実装
   - エラー発生時のユーザーフィードバックの改善

### コミット履歴管理の推奨事項

以下の変更をコミットする必要があります：

1. **データ永続化関連**
   - `src/lib/supabase/blogService.ts`の変更
   - セッション管理の改善
   - エラーハンドリングの強化

2. **ドキュメント更新**
   - 開発状況レポートの更新
   - トラブルシューティングガイドの更新

推奨コミットメッセージ：
```
feat(blog): データ永続化の信頼性向上

- セッション管理の強化
  - 自動再取得機能
  - リトライメカニズム
- データ整合性の改善
  - バックアップ処理
  - ロールバック機能
- エラーハンドリングの強化
  - 型安全性の向上
  - 詳細なエラーチェック

Issue: #データ保存の信頼性向上 
```

## 重要：サーバー起動手順（2025-02-17 追記）

### 確実に動作する起動手順

1. **実行権限の付与**
```bash
chmod +x scripts/start-servers.sh
```

2. **サーバーの起動**
```bash
./scripts/start-servers.sh
```

### start-servers.shの内容
```bash
#!/bin/bash

# 既存のプロセスを停止
pkill -f "node scripts/server.js" || true

# バックエンドサーバーの起動
NODE_OPTIONS="--max-old-space-size=512 --expose-gc" NODE_ENV=development node scripts/server.js > logs/server.log 2>&1 &

# フロントエンドの起動
npm run dev
```

### 重要な注意点
1. 起動スクリプトはシンプルに保つことが重要
2. 複雑な条件分岐や環境チェックは避ける
3. メモリ制限（512MB）とガベージコレクションの設定は必須
4. ログは`logs/server.log`に出力される
5. バックエンドは`&`でバックグラウンド実行する
6. フロントエンドは最後に起動する

### トラブルシューティング
もし起動に失敗した場合：
1. `logs`ディレクトリの存在を確認
2. 実行権限が正しく設定されているか確認
3. 既存のプロセスが完全に停止しているか確認
4. ポート（3000, 5173）が利用可能か確認

### 動作確認方法
1. バックエンド: http://localhost:3000/health にアクセス
2. フロントエンド: http://localhost:5173 にアクセス

## 現在の安定設定（2025-02-17 追記）

### サーバーリソース設定
```javascript
// メモリ管理設定
{
  gcInterval: 60000,           // GCの間隔: 1分
  warningThreshold: 75,        // 警告閾値: 75%
  criticalThreshold: 85,       // クリティカル閾値: 85%
  maxConsecutiveHighMemory: 5, // 連続検出回数: 5回
  streamBufferSize: 16 * 1024  // バッファサイズ: 16KB
}

// リソース管理設定
{
  cleanupInterval: 60000,      // クリーンアップ間隔: 1分
  maxConcurrentRequests: 10,   // 同時リクエスト数: 10
}

// サーバー起動オプション
NODE_OPTIONS="--max-old-space-size=512 --expose-gc"
```

これらの設定は現在安定して動作しているため、変更は避けること。

## 現在の問題点（2025-02-17 20:00追記）

### 1. サーバー起動の不安定性
- メモリ使用量が不安定で、予期せぬシャットダウンが発生
- 環境変数の設定が複雑で、起動コマンドが統一されていない
- ログファイルの書き込み権限の問題が時々発生

### 2. Supabaseとの連携問題
- セッション管理が不安定で、`session has not expired expires_at`エラーが頻発
- `blog_sections`テーブルのカラムが見つからないエラーが発生
- データの永続化に関する信頼性の問題

### 3. 開発環境の一貫性
- 開発環境のセットアップが複雑
- 環境変数の管理が煩雑
- ローカル環境とクラウド環境の差異による問題

## 確定した起動手順（2025-02-17 20:00追記）

### 1. 前提条件の確認
```bash
# Node.jsバージョン確認（v18.0.0以上が必要）
node -v

# 必要なディレクトリの存在確認
ls logs || mkdir -p logs
```

### 2. 環境変数の確認
```bash
# .envファイルが存在することを確認
ls .env || cp .env.development .env
```

### 3. サーバーの起動（推奨方法）
```bash
# スクリプトを使用した起動（推奨）
npm run start-all
```

### 4. 個別起動が必要な場合
```bash
# バックエンドサーバー
NODE_ENV=development NODE_OPTIONS="--max-old-space-size=512 --expose-gc" node scripts/server.js > logs/server.log 2>&1 &

# フロントエンド
npm run dev
```

### 5. 動作確認
1. バックエンドの確認
   ```bash
   curl http://localhost:3000/health
   ```
   期待される応答: `{"status":"ok"}`

2. フロントエンドの確認
   - ブラウザで http://localhost:5173 にアクセス
   - ログイン画面が表示されることを確認

### 6. トラブルシューティング
```bash
# プロセスの確認
ps aux | grep node
ps aux | grep vite

# ログの確認
tail -f logs/server.log

# プロセスの強制終了（必要な場合）
pkill -f "node scripts/server.js"
pkill -f vite
```

### 7. 重要な注意点
- メモリ制限（512MB）は必ず設定すること
- ログディレクトリは事前に作成すること
- 環境変数は`.env`または`.env.development`から読み込まれること
- バックエンドは必ずバックグラウンドで実行すること
- フロントエンドは最後に起動すること

### データベースとアプリケーションの連携改善（2024-02-19）

#### 1. データベースカラム名の最適化
- 問題：`blog_sections`テーブルの`order`カラムがSQLの予約語と競合
- 改善内容：
  - カラム名を適切にダブルクォートで囲む対応を実施
  - アプリケーション側でも一貫した命名規則を適用

#### 2. 記事生成フローの改善
- 問題：AIによる記事構成生成後に意図しない画面遷移が発生
- 改善内容：
  - 記事構成生成後の画面遷移制御を最適化
  - ユーザーが生成された内容を確認・編集できるように改善
  - 自動保存機能との連携を強化

#### 3. パフォーマンスの改善
- 問題：サーバーの応答速度が遅く、メモリ使用量が高かった
- 改善内容：
  - Node.jsのメモリ制限を適切に設定（512MB）
  - サーバー起動スクリプトを最適化
  - エラーハンドリングとログ管理を改善

### 動作確認済みの機能
- ✅ ユーザー認証
- ✅ 記事の作成・編集・削除
- ✅ AIによる記事構成生成
- ✅ AIによるタイトル生成
- ✅ AIによる本文生成
- ✅ 自動保存機能
- ✅ プレビュー機能
- ✅ マークダウンエクスポート

## 環境変数の管理方法（2025-02-19追記）

### 現在のフォルダ構造

```plaintext
プロジェクトルート/
├── .env                  # 現在の開発環境設定（.env.developmentのコピー）
├── .env.development      # 開発環境の基準となる設定ファイル
├── env_backup/          # 環境変数のバックアップディレクトリ
│   ├── .env             # 以前のメイン設定（バックアップ）
│   └── .env.production  # 本番環境用設定（バックアップ）
└── ...その他のプロジェクトファイル
```

### 環境変数ファイルの役割

1. **アクティブな設定ファイル**
   - `.env`: 現在の開発環境で使用される設定
   - `.env.development`: 開発環境の基準となる設定（変更時は`.env`にコピーする）

2. **バックアップされた設定ファイル** (`env_backup/`ディレクトリ内)
   - `.env`: 以前使用していた設定のバックアップ
   - `.env.production`: 本番環境用設定のバックアップ

### 環境変数の管理ルール

1. **設定の更新手順**
   - 開発環境の設定を変更する場合は、まず`.env.development`を編集
   - 編集後、`.env.development`を`.env`にコピーして反映
   - 変更前の設定は`env_backup`ディレクトリに移動して保管

2. **GitHubでの管理**
   - すべての環境変数ファイル（`.env*`）はGitHubにアップロードされない
   - `env_backup`ディレクトリもGitHubにアップロードされない
   - これにより機密情報の漏洩を防止

3. **バックアップの参照**
   - 過去の設定を確認する必要がある場合は`env_backup`ディレクトリ内のファイルを参照
   - 本番環境の設定が必要な場合も同様

### 必要な環境変数

1. **フロントエンド用（Vite/React）**
   ```
   VITE_SUPABASE_URL=<Supabase プロジェクトURL>
   VITE_SUPABASE_ANON_KEY=<Supabase 匿名キー>
   VITE_SUPABASE_FUNCTIONS_URL=<Supabase Functions URL>
   ```

2. **バックエンド用（Node.js/Express）**
   ```
   OPENAI_API_KEY=<OpenAI APIキー>
   NODE_ENV=development
   PORT=3000（オプション）
   ```

### 注意事項

1. 環境変数を更新する際は、必ず`.env.development`を先に更新し、その後`.env`にコピー
2. 新しい環境変数を追加する場合は、このドキュメントにも追記
3. バックアップは定期的に整理し、不要になった設定ファイルは削除
4. 本番環境の設定は必ず`env_backup`ディレクトリで保管